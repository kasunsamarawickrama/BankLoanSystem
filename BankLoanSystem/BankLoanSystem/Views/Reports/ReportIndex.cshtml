@model BankLoanSystem.Models.LoanIdNumberViewModel

@{
    Layout = "~/Views/Shared/_DashBoardLayout.cshtml";
    ViewBag.Title = "Reports";
}

<link rel="stylesheet" href="~/Content/commonActions.css">
@*Date picker*@
<link href="~/Content/pikaday.css" rel="stylesheet" />
<link href="~/Content/theme.css" rel="stylesheet" />
<link href="~/Content/triangle.css" rel="stylesheet" />
<script src="~/scripts/moment.js"></script>
<script src="~/scripts/pikaday.js"></script>

<script src="~/scripts/jquery-1.10.2.min.js"></script>
<script src="~/scripts/bootstrap.min.js"></script>


<script src="~/scripts/bootstrap.min.js"></script>

<link href="~/Content/overlaypopup.css" rel="stylesheet" />

<style>
    .btns-clm > button{
        width:100px;
        height:60px;
        margin-left:5px;
        margin-right:5px;

    }

</style>
<div class="container-child">
    @{Html.RenderAction("LoanInfo", "Unit", new { title = @ViewBag.Title, msg = @ViewBag.Msg });
    }
    <div class="container" id="container">




        <div class="btns-clm" id="divRptType">
            <input type="hidden" name="selectedButton" id="hdnSelectedButton" value=""/>
            <button  type="button" id="btnLotInspection" class="btn btn-info">Lot<br/> Inspection</button>
            <button  type="button" id="btnCurtailmentInvoice" class="btn btn-info">Curtailment<br/> Invoice </button>

            <button  type="button" id="btnCurtailmentReceipt" class="btn btn-info">Curtailment<br/> Receipt </button>

            <button  type="button" id="btnTitlesStatus" class="btn btn-info">Title <br/>Status</button>
            <button  type="button" id="btnFees" class="btn btn-info">Fees</button>
            <button  type="button" id="btnPayOff" class="btn btn-info">Pay Off</button>
            @*<div id="2" href="#">
                    <p style="color: white">advance a unit</p>
                </div>
                <div id="3" href="#">
                    <p style="color: white">unit curtailments</p>
                </div>*@
        </div>

        <hr/>


        <!---->
        <div style="margin-top:15px;" id="liFilteringSection">
            <div class="form-inline">
                <div id="lnum" class="form-group">
                    <label for="">Loan Number</label>

                    @if (Enumerable.Count(ViewBag.LoanId) == 1)
                    {
                        @Html.HiddenFor(model => model.LoanId, new { @Value = (int)ViewBag.LoanId.Items[0].LoanId, })
                        @Html.LabelFor(model => model.LoanId, (string)ViewBag.LoanId.Items[0].LoanNumberB, htmlAttributes: new { @class = "form-control text_field_input", style = "border:none;border-radius:none;-webkit-box-shadow:nonr;box-shadow:none;margin-top: 3px;display: block;" })
                    }
                    else
                    {
                        @Html.DropDownListFor(model => model.LoanId, null, "--Select loan number--", htmlAttributes: new { @class = "form-control text_field_input", id = "LoanId" })
                        @Html.ValidationMessageFor(model => model.LoanId, "", new { @class = "text-danger", style = "left:25%" })
                        <div id="tagscloudLoanId" class="validation-error"><span class="text-danger"></span></div>
                    }

                </div>

                <div id="strdate" class="form-group hf" style="margin-left:20px;">
                    <label for="">Start Date</label>


                    
                    @Html.EditorFor(model => model.StartDate, new { htmlAttributes = new { @class = "form-control dateKeyPressValidate", @id = "startDate", Value = "", @placeholder = "MM/DD/YYYY", autocomplete = "off" } })
                        @Html.ValidationMessageFor(model => model.StartDate, "", new { @class = "text-danger", style = "left:25%" })
                        <div id="tagscloudStartDate" class="field-validation-error"><span class="text-danger"></span></div>
                </div>

                <div id="enddate" class="form-group hf" style="margin-left:20px;">
                    <label for="">End Date</label>

                    @Html.EditorFor(model => model.EndDate, new { htmlAttributes = new { @class = "form-control dateKeyPressValidate", @id = "endDate", Value = "", @placeholder = "MM/DD/YYYY", autocomplete = "off" } })
                    @Html.ValidationMessageFor(model => model.EndDate, "", new { @class = "text-danger", style = "left:25%" })
                    <div id="tagscloudEndDate" class="field-validation-error"><span class="text-danger"></span></div>


                </div>

                <div id="ttlsts" class="form-group hf" style="margin-left:20px;display:none">
                    <label for="">Title Status</label>


                    @{
                        List<SelectListItem> TitleStatus = new List<SelectListItem>();

                        TitleStatus.Add(new SelectListItem
                        {
                            Text = "Not Received",
                            Value = "0"
                        });
                        TitleStatus.Add(new SelectListItem
                        {
                            Text = "Received",
                            Value = "1"
                        });
                        TitleStatus.Add(new SelectListItem
                        {
                            Text = "Returned to Dealer",
                            Value = "2"
                        });
                    }
                    @Html.DropDownList("Title Status", TitleStatus, "-- select type --", new { @class = "form-control", @id = "titleStatus"  })
                    <div id="tagscloudTitleStatus" class="field-validation-error"><span class="text-danger"></span></div>


                </div>


               

            </div>

            <div class="form-inline" style="margin-top:15px">
                <div class="form-group">
                    

                    <button style="width: 100px" type="button" id="btnDisplay" class="btn btn-info">Display</button>
                    <button style="width: 100px;display:none;float:right;" type="button" id="btnPrint" class="btn btn-info" >Print</button>

                </div>

                
               

                

                

            </div>

        </div>
        <!---->
        

        <hr/>

        <div id="reportViewerDiv" hidden>
            <iframe id="ifrmReportViewer" style="height: 700px; width: 100%;" frameborder="1" scrolling="no"></iframe>
        </div>

    </div>
</div>
<script type="text/javascript">
    //$(document).ready(function() {
    //    Report();
    //});

    var errorCount = 0;

    function ChangeButtonColor(id) {
        $(id).css({ 'background': 'green' });
        $('#divRptType').children('button').not(id).css({ 'background': '#5bc0de' });
    }

    $('#btnLotInspection').click(function () {
        errorCount = 0;
        ChangeButtonColor(this);
        $('#hdnSelectedButton').val('LotInspection');
        $('#lnum').siblings('.hf').hide();
    });

    $('#btnCurtailmentInvoice').click(function () {
        errorCount = 0;
        ChangeButtonColor(this);
        $('#hdnSelectedButton').val('CurtailmentInvoice'); 
        $('#ttlsts').hide().siblings('.hf').show();
    });

    $('#btnCurtailmentReceipt').click(function () {
        errorCount = 0;
        ChangeButtonColor(this);
        $('#hdnSelectedButton').val('CurtailmentReceipt');
        $('#ttlsts').hide().siblings('.hf').show();
    });

    $('#btnTitlesStatus').click(function () {
        errorCount = 0;
        ChangeButtonColor(this);
        $('#hdnSelectedButton').val('TitlesStatus');
        $('#ttlsts').show().siblings('.hf').hide();
    });

    $('#btnDisplay').click(function () {
        var rptType = $('#hdnSelectedButton').val();
        //alert(reportType);

        if (rptType !== '') {
            var input = $("#LoanId");

            var urlPrefix = "";

            if (rptType === 'LotInspection') {
                urlPrefix = "../Reports/RptDivLotInspection.aspx?loanId=";
            }
            else if (rptType === 'CurtailmentInvoice') {
                urlPrefix = "../Reports/RptDivCurtailmentInvoice.aspx?loanId=";
            }
            else if (rptType === 'CurtailmentReceipt') {
                urlPrefix = "../Reports/RptDivCurtailmentReceipt.aspx?loanId=";
            }
            else if (rptType === 'TitlesStatus') {
                urlPrefix = "../Reports/RptDivTitleStatus.aspx?loanId=";
            }
            var selectedIndex;
            if (input.attr('type') !== 'hidden') {
                selectedIndex = $("#LoanId option:selected").index();
                //alert(selectedIndex);
                if (selectedIndex === 0) {
                    $('#tagscloudLoanId').children('span').text("Please select a loan");
                    $("#LoanId").addClass('input-validation-error');
                    errorCount = errorCount + 1;
                    //return;
                } else {
                    $('#tagscloudLoanId').children('span').text("");
                    $("#LoanId").removeClass('input-validation-error');
                }
            }

            var val = $('#LoanId').val();

            //alert(val);

            if (rptType === 'CurtailmentInvoice' || rptType === 'CurtailmentReceipt') {
                var startDate = $('#startDate').val();
                //alert(startDate);
                if (startDate === '') {
                    $('#tagscloudStartDate').children('span').text("Please select start date");
                    $("#startDate").addClass('input-validation-error');
                    errorCount = errorCount + 1;
                    //$('.centered span').text('Error');
                    //return;
                } else {
                    $('#tagscloudStartDate').children('span').text("");
                    $("#startDate").removeClass('input-validation-error');
                }

                var endDate = $('#endDate').val();
                if (endDate === '') {
                    $('#tagscloudEndDate').children('span').text("Please select end date");
                    $("#endDate").addClass('input-validation-error');
                    errorCount = errorCount + 1;
                    //$('.centered span').text('Error');
                    //return;
                } else {
                    $('#tagscloudEndDate').children('span').text("");
                    $("#endDate").removeClass('input-validation-error');
                }

                if (errorCount <= 0) {

                    if (new Date(startDate) >= new Date(endDate)) {
                        $('#tagscloudEndDate').children('span').text("Start date must be greater than end date");
                        $("#startDate").addClass('input-validation-error');
                        $("#endDate").addClass('input-validation-error');
                        return;
                    }

                    $('#tagscloudEndDate').children('span').text("");
                    $("#startDate").removeClass('input-validation-error');
                    $("#endDate").removeClass('input-validation-error');

                    $('#reportViewerDiv').show();
                    //alert(input.attr('type'));
                    urlPrefix = urlPrefix + val + "&startDate=" + startDate + "&endDate=" + endDate;
                    ReportCurtailmentInvoice(val, urlPrefix);
                }
            } else if (rptType === 'LotInspection') {
                urlPrefix = urlPrefix + val;
                ReportCurtailmentInvoice(val, urlPrefix);
            } else if (rptType === 'TitlesStatus') {
                //Report(val, urlPrefix);
                //tagscloudTitleStatus
                selectedIndex = $("#titleStatus option:selected").index();
                if (selectedIndex === 0) {
                    $('#tagscloudTitleStatus').children('span').text("Please select title status");
                    $("#titleStatus").addClass('input-validation-error');
                    errorCount = errorCount + 1;
                    //return;
                } else {
                    $('#tagscloudTitleStatus').children('span').text("");
                    $("#titleStatus").removeClass('input-validation-error');
                    urlPrefix = urlPrefix + val + '&titleStatus=' + selectedIndex;
                    ReportCurtailmentInvoice(val, urlPrefix);
                }
                //alert(selectedIndex);
            }

            //alert(errorCount);




        } else {
            alert('Please select report type');
        }
    });

    function isValidDate(dateString) {
        // First check for the pattern
        if (!/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString))
            return false;

        // Parse the date parts to integers
        var parts = dateString.split("/");
        var day = parseInt(parts[1], 10);
        var month = parseInt(parts[0], 10);
        var year = parseInt(parts[2], 10);

        // Check the ranges of month and year
        if (year < 1000 || year > 3000 || month == 0 || month > 12)
            return false;

        var monthLength = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

        // Adjust for leap years
        if (year % 400 == 0 || (year % 100 != 0 && year % 4 == 0))
            monthLength[1] = 29;

        // Check the range of the day
        return day > 0 && day <= monthLength[month - 1];
    };


    $('#startDate').blur(function () {

        if ($(this).val() === "") {
            // required error
            $('#tagscloudStartDate').children('span').text('Start date required');
            $(this).addClass('input-validation-error');
            return;
        }
        var valid = isValidDate($(this).val());
        if (valid) {
            $('#tagscloudStartDate').children('span').text('');
            $(this).removeClass('input-validation-error');
            //var selectedDate = new Date($(this).val());
            //var minDate = new Date
            //var maxDate = new Date
            //if (selectedDate < minDate || selectedDate > maxDate) {
            //    // out off range error
            //    $('#customErrorPayDate').children('span').text('Out of Range');
            //    $(this).addClass('input-validation-error');
            //    //$('.centered span').text('Error');
            //} else {
            //    // delete error mssage
            //    $('#customErrorPayDate').children('span').text('');
            //    $(this).removeClass('input-validation-error');
            //}
        } else {

            // not valid data error
            $('#tagscloudStartDate').children('span').text('Not valid date');
            $(this).addClass('input-validation-error');
            //$('.centered span').text('Error');
        }

        if ($('#startDate').val() === '') {
            $('#tagscloudStartDate').children('span').text('');
            $(this).removeClass('input-validation-error');
            //$('.centered span').text('');
        }

    });

    $('#endDate').blur(function () {

        if ($(this).val() === "") {
            // required error
            $('#tagscloudEndDate').children('span').text('End date required');
            $(this).addClass('input-validation-error');
            return;
        }
        var valid = isValidDate($(this).val());
        if (valid) {
            $('#tagscloudEndDate').children('span').text('');
            $(this).removeClass('input-validation-error');
        } else {

            // not valid data error
            $('#tagscloudEndDate').children('span').text('Not valid date');
            $(this).addClass('input-validation-error');
            //$('.centered span').text('Error');
        }

        if ($('#endDate').val() === '') {
            $('#tagscloudEndDate').children('span').text('');
            $(this).removeClass('input-validation-error');
            //$('.centered span').text('');
        }

    });

    $('#LoanId').click(function () {
        //alert($(this));
        $('#tagscloudLoanId').children('span').text('');
        $(this).removeClass('input-validation-error');
    });

    $('#titleStatus').click(function () {
        //alert($(this));
        $('#tagscloudTitleStatus').children('span').text('');
        $(this).removeClass('input-validation-error');
    });

    $('#btnPrint').click(function () {
        $.ajax({
            type: "POST",
            url: '/Reports/PrintPage',
            data: "",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (msg) {

            },
            error: function (e) {

            }
        });
    });

    //function Report(val, url) {
    //    //var url = "../Reports/ReportDivLotInspection.aspx?loanId=" + val;
    //    url = url + val;
    //    alert(url);
    //    var myFrame = document.getElementById('ifrmReportViewer');
    //    if (myFrame !== null) {
    //        if (myFrame.src) {
    //            myFrame.src = url;
    //        } else if (myFrame.contentWindow !== null && myFrame.contentWindow.location !== null) {
    //            myFrame.contentWindow.location = url;
    //        } else {
    //            myFrame.setAttribute('src', url);
    //        }
    //    }
    //}

    function ReportCurtailmentInvoice(val, url) {
        //alert(startDate + ' ' + endDate);
        var myFrame = document.getElementById('ifrmReportViewer');
        if (myFrame !== null) {
            if (myFrame.src) {
                myFrame.src = url;
            } else if (myFrame.contentWindow !== null && myFrame.contentWindow.location !== null) {
                myFrame.contentWindow.location = url;
            } else {
                myFrame.setAttribute('src', url);
            }
        }
    }


    var startDate = new Pikaday({
        field: document.getElementById('startDate'),
        format: 'l'
    });

    var endDate = new Pikaday({
        field: document.getElementById('endDate'),
        format: 'l'
    });
</script>
