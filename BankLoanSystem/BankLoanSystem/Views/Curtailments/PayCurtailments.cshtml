@model BankLoanSystem.Models.CurtailmentScheduleModel

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<link href="~/Content/pikaday.css" rel="stylesheet" />
<link href="~/Content/theme.css" rel="stylesheet" />
<link href="~/Content/triangle.css" rel="stylesheet" />
<script src="~/scripts/moment.js"></script>
<script src="~/scripts/pikaday.js"></script>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>

@{
    Layout = null;
    ViewBag.Title = "Pay Curtailments";
    WebGrid grid = new WebGrid(Model.CurtailmentScheduleInfoModel, defaultSort: "CreatedDate", canPage: false);
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Pay Curtailments</title>

    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    @*<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>*@

    <link href="~/Content/bootstrap.min.css" rel="stylesheet" />
    <script src="~/scripts/jquery-1.10.2.min.js"></script>
    <script src="~/scripts/bootstrap.min.js"></script>
    <link href="~/Content/commonActions.css" rel="stylesheet" />

</head>
<body>

    <div class="container" id="container">




        @{
            Html.RenderAction("LoanInfo", "Unit", new { title = @ViewBag.Title, msg = @ViewBag.Msg });
        }



        <div class="details-container">

            @*<div class="right-panel">
                @{
//Html.RenderAction("LoanPaymentDetails", "Unit");
                }

            </div>*@


            <div class="body-content" style="float:right;margin-bottom:15px;width:100%;height:auto">
                <div class="info-bar">
                    <div class="form-group row" style="margin-bottom: 0px;">
                         <label for="" class="col-sm-4 form-control-label">Curtailment due Date - all curtailments due prior to and on this date will be displayed.</label>
                        <div class="col-md-2"  >
                            @*<input class="form-control" type="date" />*@
                            @Html.EditorFor(model => model.DueDate, new { htmlAttributes = new { @class = "form-control", @placeholder = "MM/DD/YYYY", @id = "dueDate", autocomplete = "off" } })
                        </div>
                    </div> 
                </div>
                
                <div class="info-bar" id ="checkableGridDiv" style="margin-top:15px">
                    <!-- This is for Grid--> 
                                @grid.GetHtml(
                                   tableStyle: "gridtable",
                                   headerStyle: "webgrid-header",
                                   alternatingRowStyle: "webgrid-alternating-row",
                                   rowStyle: "webgrid-row-style",
                                   htmlAttributes: new { id = "checkableGrid" },
                                   columns: grid.Columns(
                                   grid.Column(
                                        format:@<text><input type="checkbox" value="@item.UnitId" name="ids" class="checkboxAll" id="all"/></text>
                                           , header: "{checkall}"
                                   ),
                                   grid.Column(
                                        "AdvanceDate",
                                        "Date Advanced",
                                        format: (item) => string.Format("{0:MM/dd/yyyy}", item.AdvanceDate)
                                   ),
                                   grid.Column("VIN/HIN/serial #", "VIN/HIN/serial #", canSort: false, format:@<text>@{<label id="vin" class="vin">@item.IDNumber</label>}</text>),
                                   grid.Column("Year", "Year", format:@<text>@{<label id="year" class="year">@item.Year</label>}</text>),
                                   grid.Column("Make", "Make", format:@<text>@{<label id="make" class="make">@item.Make</label>}</text>),
                                   grid.Column("Model", "Model", format:@<text>@{<label id="model" class="model">@item.Model</label>}</text>),
                                   grid.Column("CurtNumber", "Curt-Number", format:@<text>@{<label id="model" class="model">@item.CurtNumber</label>}</text>),
                                   grid.Column(
                                        "DueDate",
                                        "Due Date",
                                        format: (item) => string.Format("{0:MM/dd/yyyy}", item.DueDate)
                                   ),
                                   grid.Column("CurtAmount", "Curt-Amount ($)", canSort: false, style: "gridColumn", format:@<text>@{<label id="am" class="advanceAmount">@Convert.ToDecimal(item.CurtAmount).ToString("#,##0.00")</label>}</text>),
                                   grid.Column(null, null, format: @<input type="hidden" id="curtailmentStatus" name="curtailmentStatus" value="@item.Status" />)
                                )
                            )
                        
                        <div id="subtotal"> Current Curtailment : $ 0 </div>
                        <div id="unitid" class="hidden"></div>
                </div>

                <div class="info-bar" style="margin-top:15px">
                    <div class="form-inline">
                        <div class="form-group">
                            <label for="">Pay Date : </label>
                            <input class="form-control" type="date" style="margin-left:15px"  />                            
                        </div>                        
                        <button type="submit" class="btn btn-primary" style="margin-left:15px">Pay Curtailments on all selected</button>
                    </div>
                </div>


                <div class="info-bar search-panel" style="margin-top:15px;">
                    <div class="form-inline" style="margin-left:25px;">
                        <div class="form-group">
                            <label for="">VIN/HIN/Serial</label>

                            <input class="form-control" type="text"  />

                        </div>

                        <div class="form-group" style="margin-left:20px;">
                            <label for="">Year</label>

                            <input class="form-control" type="text" style="width:90px" />

                        </div>

                        <div class="form-group" style="margin-left:20px;">
                            <label for="">Make</label>

                            <input class="form-control" type="text"  style="width:90px"/>

                        </div>

                        <div class="form-group" style="margin-left:20px;">
                            <label for="">Model</label>

                            <input class="form-control" type="text"  style="width:100px"/>

                        </div>

                        <button type="submit" class="btn btn-info" style="margin-right:25px;float:right;">Search</button>
                    </div>



                </div>


                <div class="info-bar" style="margin-top:15px">

                    <!-- This is for Search Grid-->



                </div>

                <div class="info-bar" style="margin-top:15px">

                    <div class="row">
                        <div class="col-xs-12">
                            <form>
                                <fieldset>
                                    <div class="form-group row">
                                        <div class="col-md-2">
                                            <label for="">Date Advanced </label>
                                            <input type="text" class="form-control">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="">Vin/HIN/Serial </label>
                                            <input type="text" class="form-control" >
                                        </div>
                                        <div class="col-md-2">
                                            <label for="firstName">Year </label>
                                            <input type="text" class="form-control">
                                        </div>

                                        <div class="col-md-2">
                                            <label for="">Make </label>
                                            <input type="text" class="form-control">
                                        </div>

                                        <div class="col-md-2">
                                            <label for="firstName">Model </label>
                                            <input type="text" class="form-control">
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-md-2">
                                            <label for="">Curt-Amount </label>
                                            <input type="text" class="form-control">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="">Curt Pay Date </label>
                                            <input type="text" class="form-control">
                                        </div>
                                    </div>
                                  
                                   
                                    
                                    
                                    <button type="submit" class="btn btn-info" style="width:100px">Pay</button>
                                    <button type="button" class="btn btn-default" style="float:right;">Cancel</button>
                                </fieldset>
                            </form>
                        </div>
                    </div>



                </div>


            </div>

        </div>


        <div class="link-bar" style="margin-bottom:15px;">


            @{
                Html.RenderAction("GetLinkBar", "Unit");
            }


        </div>


    </div>
    <script>
       
        $("#lkcrtl").before($(".link")).addClass('active').attr("disabled", "disabled").css('cursor', 'default').css('opacity', 'initial').siblings().removeClass('active').removeAttr('disabled');
        $("#lkcrtl").click(function (e) { e.preventDefault(); });
        $("#lkcrtl").siblings().click(function (e) {
            return true;

        });
   
            var total = 0;
            var checkCount = 0;
            var totalRecCount = 0;

            $(function () {
                GridUpdate();
            });           

            function GridUpdate() {
               var ctrl =
                       $('<input />', {
                           type: 'checkbox',
                           id: "cbSelectAll",
                           click: function () {
                               var checkboxes = $(this).closest('table').find('tbody tr td input[type="checkbox"]');
                               checkboxes.prop('checked', $(this).is(':checked'));
                               var chk = checkboxes.prop('checked');
                              
                               if (chk) {
                                   var checkBoxText = $('<div />').attr({ id: 'someID' }).html('<span> Deselect </span>');
                                   $('.gridtable thead tr th:first').html(checkBoxText.prepend(ctrl));
                                   $("#iAdvance").attr("disabled", "disabled");

                               } else {
                                   var checkBoxText = $('<div />').attr({ id: 'someID' }).html('<span> Select </span>');
                                   $('.gridtable thead tr th:first').html(checkBoxText.prepend(ctrl));
                                   $("#btnAdvanceAll").attr("disabled", "disabled");
                                   $("#startDate").attr("disabled", "disabled");
                                   $("#iAdvance").attr("disabled", "disabled");
                                   totalRecCount = 0;

                               }
                               total = 0;
                               totalRecCount = 0;
                               $('.advanceAmount').each(function () {
                                   var tr = $(this).parents('tr:first');                                   
                                   totalRecCount++;
                                   if (document.getElementById('all').checked) {
                                       total = total + parseFloat(tr.find("#am").text().replace(',', ''));
                                       checkCount++;

                                       $(this).parents('tr').css('background', 'lightblue');
                                   } else {
                                       checkCount = 0;
                                       total = 0;
                                       $(this).parents('tr').css('background', 'transparent');
                                   }
                                   document.getElementById("subtotal").innerHTML = "Current Total to Advance : $ " + total;
                                   if (checkCount > 0) {
                                       $("#btnAdvanceAll").removeAttr("disabled");
                                       $("#startDate").removeAttr("disabled");
                                       if (totalRecCount == 1) {
                                           //SetTextBoxValues(tr);
                                       }
                                   }

                               });
                               if (checkCount > 1) {
                                   //ClearTextBoxValues();
                               }
                               else if (checkCount == 0 || totalRecCount == 0) {
                                   $("#btnAdvanceAll").attr("disabled", "disabled");
                                   $("#startDate").attr("disabled", "disabled");
                                   //ClearTextBoxValues();
                               }

                           }
                       })


               var gg = $('<div />').attr({ id: 'someID' }).html('<span> Select </span>');
                    $('.gridtable thead tr th:first').html(gg.prepend(ctrl));


                    $('.checkboxAll').change(function () {
                        alert('aaa');
                        var tr = $(this).parents('tr:first');
                        //var fullcost = parseFloat(tr.find("#am").text().replace(',', ''));
                        //var numValue = Number.parseFloat(tr.find("#am").text());
                        //alert(fullcost);
                        var checked = tr.find("#all").is(':checked');
                       
                        if (checked) {
                            total = total + parseFloat(tr.find("#am").text().replace(',', ''));
                            checkCount++;
                            $(this).parents('tr').css('background', 'lightblue');
                        } else {
                            total = total - parseFloat(tr.find("#am").text().replace(',', ''));
                            checkCount--;
                            $(this).parents('tr').css('background', 'transparent');
                        }

                        if (checkCount == 1) {
                            if (checked) {
                                SetTextBoxValues(tr);

                            } else {
                                $('.advanceAmount').each(function () {

                                    var tr = $(this).parents('tr:first');
                                    var checked = tr.find("#all").is(':checked');

                                    if (checked) {
                                        SetTextBoxValues(tr);
                                    }
                                });
                            }
                            document.getElementById("subtotal").innerHTML = "Current Total to Advance : $ " + total;
                            $("#btnAdvanceAll").removeAttr("disabled");
                            $("#startDate").removeAttr("disabled");
                        }
                        else if (checkCount == 0) {
                            document.getElementById("subtotal").innerHTML = "Current Total to Advance : $ 0";
                            ClearTextBoxValues();
                            $("#btnAdvanceAll").attr("disabled", "disabled");
                            $("#startDate").attr("disabled", "disabled");
                            $("#iAdvance").attr("disabled", "disabled");
                            $("#someID span").html('Select')

                        }
                        else {
                            ClearTextBoxValues();
                            document.getElementById("subtotal").innerHTML = "Current Total to Advance : $ " + total;
                        }

                        if (checkCount > 0) {
                            var chkText = $('<div />').attr({ id: 'someID' }).html(' <span> Select </span>');
                            $('.gridtable thead tr th:first').html(chkText.prepend(ctrl));
                            //ChangeCheckBoxText('select ');

                            var totalRows = $("#checkableGrid td :checkbox").length;
                            var checked = $("#checkableGrid td :checkbox:checked").length;

                            if (checked == totalRows) {
                                var chkText = $('<div />').attr({ id: 'someID' }).html('<span>  Deselect </span>');
                                $('.gridtable thead tr th:first').html(chkText.prepend(ctrl));
                            }
                        }

                    });
                }

            

            $(document).on('click', 'tbody', (function (e) {
                var target = $(e.target);
                if (target.parents('#checkableGrid').length) {
                    var $td = $(e.target).closest("td");
                    var rowIndex = $td.parent().index();
                    rowIndex +=1;
                    var ColIndex = $td.parent().children().index($td);
                    var table = document.getElementById("checkableGrid");
                    var row = $("tr:eq(" + rowIndex + ")", '#checkableGrid');
                    ClearLabelMessages();

                    if (ColIndex != 0) {

                        var checked = row.find("#all").prop('checked');
                        if (!checked) {
                            row.find("#all").prop('checked', true);
                            row.css('background', 'lightblue');

                            checkCount++;
                            total = total + parseFloat(row.find("#am").text().replace(',', ''));

                            if (checkCount == 1) {
                                SetTextBoxValues(row);
                            }
                            else {
                                SetRadioBtnHeaderChecked();
                                ClearTextBoxValues();
                            }
                            document.getElementById("subtotal").innerHTML = "Current Total to Advance : $ " + total;

                            $("#btnAdvanceAll").removeAttr("disabled");
                            $("#startDate").removeAttr("disabled");
                        }
                    } else {
                        SetRadioBtnHeaderChecked();
                    }
                }
            }));

            startPicker = new Pikaday({                
                field: document.getElementById('dueDate'),
                format: 'l',
                bound: true,
                onSelect: function () {
                    var dueDate = this.getDate();
                    $.ajax({
                        url: '/Curtailments/PayCurtailmentForSelectedDueDate/',
                        data: JSON.stringify({ dueDate: dueDate }),
                        type: 'POST',
                        contentType: 'application/json; charset=utf-8',

                        success: function (partialView) {
                            $('#checkableGridDiv').html(partialView);
                            $('#checkableGridDiv').show();
                            //$(location).attr('href', '/AdvanceUnit/Advance?flag=' + View);
                        }
                    });
                }
            });

        </script>

</body>
</html>
